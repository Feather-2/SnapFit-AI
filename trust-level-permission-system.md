# 信任等级权限控制系统

## 🎯 **权限要求**

### **核心规则**
> **只有LV1-4用户可以使用共享服务**

```
❌ LV0: 新用户     - 无法使用共享服务
✅ LV1: 信任用户   - 可以使用共享服务
✅ LV2: 高级用户   - 可以使用共享服务  
✅ LV3: VIP用户    - 可以使用共享服务
✅ LV4: 超级VIP    - 可以使用共享服务
❌ LV5+: 超出范围  - 无法使用共享服务
```

## 🔧 **技术实现**

### **1. 后端权限验证**

#### **UserManager权限方法**
```typescript
// 核心权限检查
canUseSharedService(trustLevel: number): boolean {
  return trustLevel >= 1 && trustLevel <= 4
}

// 其他权限都基于核心权限
canShareKeys(trustLevel: number): boolean {
  return this.canUseSharedService(trustLevel)
}

canManageKeys(trustLevel: number): boolean {
  return this.canUseSharedService(trustLevel)
}

isVipUser(trustLevel: number): boolean {
  return trustLevel >= 3 && trustLevel <= 4
}
```

#### **API路由权限验证**
所有共享服务相关的API都添加了权限检查：

```typescript
// 检查用户信任等级权限
const userManager = new UserManager()
const userResult = await userManager.getUserById(userId)

if (!userManager.canUseSharedService(userResult.user.trustLevel)) {
  return NextResponse.json({ 
    error: '您的信任等级不足，只有LV1-4用户可以使用共享服务' 
  }, { status: 403 })
}
```

#### **受保护的API端点**
- ✅ `POST /api/shared-keys` - 分享新配置
- ✅ `PUT /api/shared-keys` - 更新配置
- ✅ `DELETE /api/shared-keys` - 删除配置
- ✅ `GET /api/shared-keys/my-configs` - 获取我的配置
- ✅ `PATCH /api/shared-keys/[id]` - 更新单个配置
- ✅ `DELETE /api/shared-keys/[id]` - 删除单个配置

### **2. 前端权限控制**

#### **TrustLevelGuard组件**
```tsx
<TrustLevelGuard>
  <MyConfigurations />
</TrustLevelGuard>

<TrustLevelGuard>
  <KeyUploadForm />
</TrustLevelGuard>
```

#### **权限状态展示**
- 🔒 **未登录**：显示登录提示
- ⚠️ **权限不足**：显示等级要求和提升指南
- ✅ **有权限**：正常显示功能

#### **用户等级标识**
```tsx
// 等级徽章显示
LV0: 👤 新用户     (灰色)
LV1: 🛡️ LV1       (蓝色)
LV2: ⭐ LV2       (紫色)
LV3: 👑 LV3       (金色)
LV4: 👑 LV4       (橙色)
LV5+: 👤 LV5+     (红色，无权限)
```

## 📋 **用户体验流程**

### **权限不足用户**
```
1. 访问共享服务页面
2. 看到权限不足提示
3. 显示当前等级和要求
4. 提供等级提升指南
5. 引导访问Linux.do社区
```

### **有权限用户**
```
1. 正常访问所有功能
2. 显示等级徽章标识
3. 享受完整服务体验
```

## 🛡️ **安全特性**

### **多层防护**
1. **前端守卫**：TrustLevelGuard组件拦截
2. **API验证**：每个端点都验证权限
3. **数据库约束**：用户信息完整性检查

### **错误处理**
- **403 Forbidden**：权限不足
- **404 Not Found**：用户不存在
- **友好提示**：清晰的错误信息

### **权限同步**
- **OAuth登录**：自动同步最新信任等级
- **实时更新**：权限变化立即生效
- **缓存策略**：合理的权限缓存机制

## 🎨 **界面设计**

### **权限不足页面**
```
┌─────────────────────────────────────┐
│           ⚠️ 信任等级不足            │
│                                     │
│    只有信任等级LV1-4的用户可以       │
│         使用共享服务                │
│                                     │
│  ┌─────────────────────────────────┐ │
│  │ ⚠️ 您当前的信任等级：LV0 新用户  │ │
│  └─────────────────────────────────┘ │
│                                     │
│         如何提升信任等级？           │
│  • 在Linux.do社区积极参与讨论       │
│  • 发布高质量的帖子和回复           │
│  • 获得其他用户的点赞和认可         │
│  • 保持良好的社区行为记录           │
│                                     │
│      [访问 Linux.do 社区]           │
└─────────────────────────────────────┘
```

### **等级徽章系统**
```
用户信息显示：
[头像] 用户名 [LV3] • 123次使用

等级颜色：
LV0: 灰色 (无权限)
LV1: 蓝色 (基础权限)
LV2: 紫色 (标准权限)
LV3: 金色 (VIP权限)
LV4: 橙色 (超级VIP)
LV5+: 红色 (超出范围)
```

## 📊 **业务价值**

### **质量控制**
- ✅ **筛选用户**：只有活跃用户可以分享
- ✅ **降低风险**：减少恶意或低质量配置
- ✅ **提升信任**：高等级用户的配置更可靠

### **社区激励**
- 🎯 **等级动机**：鼓励用户提升信任等级
- 🏆 **身份认同**：等级徽章提供身份标识
- 🤝 **社区建设**：引导用户参与Linux.do社区

### **运营数据**
- 📈 **用户分层**：清晰的用户等级分布
- 🎯 **精准运营**：针对不同等级的差异化策略
- 📊 **质量监控**：高等级用户的贡献质量统计

## 🔄 **测试场景**

### **权限验证测试**
1. **LV0用户**：无法访问任何共享功能
2. **LV1-4用户**：可以正常使用所有功能
3. **LV5+用户**：无法使用共享功能
4. **未登录用户**：显示登录提示

### **API安全测试**
1. **直接API调用**：绕过前端的权限检查
2. **伪造权限**：尝试修改用户等级
3. **并发请求**：高并发下的权限验证
4. **边界条件**：等级边界值的处理

### **用户体验测试**
1. **权限提示**：清晰的错误信息和指导
2. **等级显示**：正确的徽章颜色和标识
3. **响应速度**：权限检查的性能影响
4. **移动端适配**：小屏幕下的显示效果

## 🚀 **后续优化**

### **动态权限**
- 📊 **行为评分**：基于用户行为的动态权限调整
- ⏰ **时间限制**：新用户的临时权限机制
- 🎯 **特殊权限**：针对特定用户的权限定制

### **权限细化**
- 🔧 **功能分级**：不同功能的不同权限要求
- 📈 **配额管理**：基于等级的使用配额限制
- 🎁 **特权功能**：高等级用户的专属功能

### **社区集成**
- 🔄 **实时同步**：与Linux.do的实时权限同步
- 📢 **等级通知**：等级变化的及时通知
- 🏆 **成就系统**：基于贡献的成就和奖励

现在系统具备了完善的信任等级权限控制，确保只有合格的用户可以使用共享服务，同时提供良好的用户体验和清晰的权限指导！🛡️
