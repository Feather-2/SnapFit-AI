# 🔄 数据同步冲突解决策略

## 📋 概述

本文档定义了健康应用中多端同步时的冲突解决策略，确保数据一致性和用户体验。

## 🎯 设计原则

### 1. **数据安全优先**
- 永远不丢失用户数据
- 冲突时优先保留更完整的数据
- 提供冲突可视化和手动解决选项

### 2. **时间戳可信度**
- 服务器时间戳 > 客户端时间戳
- 最后修改时间作为主要冲突解决依据
- 版本号作为辅助冲突检测机制

### 3. **智能合并策略**
- 数组字段：合并去重
- 数值字段：取最新值
- 对象字段：深度合并

## 🔧 具体策略

### 1. **健康日志数据** (`daily_logs`)

#### 冲突检测
```sql
-- 检测冲突：服务器版本比客户端版本新
IF current_modified > p_last_modified THEN
  conflict_detected := TRUE;
```

#### 解决策略
- **无冲突**: 直接应用补丁
- **有冲突**: 智能合并
  - 保留服务器的基础数据
  - 合并客户端的补丁更新
  - 使用最新的时间戳

#### 实现函数
```sql
upsert_log_patch(user_id, date, patch, last_modified)
```

### 2. **AI记忆数据** (`ai_memories`)

#### 冲突解决
```sql
version = GREATEST(ai_memories.version, EXCLUDED.version),
last_updated = GREATEST(ai_memories.last_updated, EXCLUDED.last_updated)
```

#### 策略特点
- **版本号优先**: 取最大版本号
- **时间戳优先**: 取最新时间戳
- **内容覆盖**: 版本号更高的内容获胜

### 3. **用户档案数据** (`user_profiles`)

#### 当前策略
- 简单覆盖（`upsert` with `ignoreDuplicates: false`）

#### 建议改进
- 添加 `last_modified` 字段
- 实现时间戳比较
- 支持字段级别的合并

## 🚨 已识别问题

### 1. **缺失的函数**
- ❌ `upsert_log_patch` 函数未实现
- ✅ 已在 `add-daily-logs-table.sql` 中添加

### 2. **不一致的策略**
- AI记忆：智能合并
- 健康日志：时间戳优先
- 用户档案：简单覆盖

### 3. **多端同步风险**
- 无分布式锁
- 网络延迟影响时间戳准确性
- 离线编辑冲突处理不完善

## 🔮 未来改进计划

### 1. **离线同步队列**
```typescript
interface SyncConflict {
  type: 'health_log' | 'ai_memory' | 'user_profile';
  localData: any;
  serverData: any;
  conflictFields: string[];
  resolutionStrategy: 'auto' | 'manual';
}
```

### 2. **可视化冲突解决**
- 显示冲突的具体字段
- 提供用户选择保留哪个版本
- 支持字段级别的选择性合并

### 3. **版本控制增强**
- 为所有表添加版本号字段
- 实现操作日志记录
- 支持数据回滚功能

### 4. **实时同步**
- WebSocket 连接检测其他设备的更新
- 实时冲突提醒
- 协作编辑支持

## 📊 监控指标

### 1. **冲突统计**
- 每日冲突发生次数
- 冲突类型分布
- 自动解决 vs 手动解决比例

### 2. **同步性能**
- 同步延迟时间
- 失败重试次数
- 数据一致性检查结果

### 3. **用户体验**
- 同步成功率
- 用户手动解决冲突的频率
- 数据丢失事件（应为0）

## 🔧 开发指南

### 1. **添加新的同步数据类型**
1. 定义冲突解决策略
2. 实现 RPC 函数
3. 添加客户端同步逻辑
4. 编写测试用例

### 2. **测试冲突场景**
1. 模拟多设备同时编辑
2. 测试网络中断恢复
3. 验证数据完整性
4. 检查性能影响

### 3. **错误处理**
1. 同步失败时的回滚机制
2. 网络错误的重试策略
3. 数据损坏的检测和修复
4. 用户友好的错误提示
