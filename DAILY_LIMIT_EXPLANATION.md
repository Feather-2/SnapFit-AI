# 每日调用限制机制说明

## 概述

每日调用限制是针对**整个 API Key** 的总调用次数限制，而不是针对每个用户的个人限制。这是一个共享资源管理机制。

## 工作原理

### 🔢 **计数机制**
- **全局计数**: 每个 API Key 有一个全局的每日使用计数器
- **所有用户共享**: 所有使用该 Key 的用户都会增加同一个计数器
- **每日重置**: 每天凌晨自动重置所有 Key 的使用计数

### 📊 **限制逻辑**
```
当前使用次数 < 每日限制 → Key 可用
当前使用次数 ≥ 每日限制 → Key 不可用（当天）
```

### 🔄 **选择策略**
1. **过滤可用 Key**: 系统只选择未达到限制的 Key
2. **负载均衡**: 在可用 Key 中进行负载均衡
3. **失败处理**: 如果所有 Key 都达到限制，返回错误

## 实际场景

### 📈 **使用示例**
假设用户 A 分享了一个 API Key，设置每日限制为 100 次：

```
时间轴：
09:00 - 用户 B 调用 20 次 → 计数器: 20/100
12:00 - 用户 C 调用 30 次 → 计数器: 50/100
15:00 - 用户 D 调用 40 次 → 计数器: 90/100
18:00 - 用户 E 调用 15 次 → 计数器: 100/100 (达到限制)
19:00 - 用户 F 尝试调用 → 失败，Key 不可用
次日 00:00 - 计数器重置 → 计数器: 0/100
```

### 🎯 **设置建议**

#### **按人数计算（每人每天150次）**
- **1-2 人**: 150-300 次/天
- **3-5 人**: 450-750 次/天
- **6-10 人**: 900-1500 次/天
- **11-20 人**: 1650-3000 次/天
- **21-50 人**: 3150-7500 次/天
- **51-100 人**: 7650-15000 次/天
- **100+ 人**: 15000+ 次/天或无限制

#### **常用配置**
- **个人使用**: 150-300 次/天 (1-2人)
- **小团队**: 750-1500 次/天 (5-10人)
- **中团队**: 3000-7500 次/天 (20-50人)
- **大团队**: 15000+ 次/天 (100+人)
- **社区开放**: 无限制（999999）

#### **特殊设置**
- **无限制**: 999999（不推荐，除非有充足预算）
- **最小值**: 150 次/天（支持1人使用）
- **最大值**: 99999 次/天（支持666人使用）

## 技术实现

### 🔧 **数据库字段**
```sql
daily_limit: integer DEFAULT 150,        -- 每日限制（150-99999或999999无限制）
usage_count_today: integer DEFAULT 0,    -- 今日使用次数
total_usage_count: integer DEFAULT 0,    -- 总使用次数
```

### 📝 **关键代码逻辑**
```typescript
// 过滤可用的 Key（支持无限制）
const availableKeys = keys.filter(key =>
  key.daily_limit === 999999 || (key.usage_count_today || 0) < (key.daily_limit || 150)
)

// 使用后增加计数
const updatedUsageCountToday = (currentKey.usage_count_today || 0) + 1
```

### ⏰ **定时重置**
```typescript
// 每日凌晨重置计数器
async resetDailyUsage() {
  await this.supabase
    .from('shared_keys')
    .update({ usage_count_today: 0 })
}
```

## 用户界面说明

### 📱 **分享时设置**
- **标签**: "每日调用限制"
- **说明**: "按每人每天150次计算，可支持 X 人使用"
- **范围**: 150-99999 次，或无限制（999999）
- **默认值**: 150 次（支持1人使用）

### 📊 **使用时显示**
- **当前状态**: "今日已使用 45/100 次"
- **可用性**: "Key 可用" / "Key 已达限制"
- **重置时间**: "明日 00:00 重置"

## 优势与考虑

### ✅ **优势**
1. **资源保护**: 防止 API Key 被过度使用
2. **成本控制**: 帮助分享者控制 API 费用
3. **公平使用**: 确保资源在用户间合理分配
4. **简单管理**: 统一的限制机制，易于理解

### ⚠️ **注意事项**
1. **共享性质**: 不是个人配额，而是共享配额
2. **先到先得**: 早使用的用户可能用完配额
3. **重置时间**: 基于服务器时区的每日重置
4. **监控需要**: 分享者需要关注使用情况

## 最佳实践

### 👥 **对于分享者**
1. **合理设置**: 根据预期使用量设置限制
2. **定期监控**: 查看使用统计和趋势
3. **及时调整**: 根据实际情况调整限制
4. **备用方案**: 准备多个 Key 以提高可用性

### 🔧 **对于使用者**
1. **理解机制**: 明白这是共享资源
2. **合理使用**: 避免不必要的 API 调用
3. **错误处理**: 准备处理限制达到的情况
4. **感谢分享**: 理解并感谢分享者的贡献

## 监控和统计

### 📈 **可用数据**
- 每日使用次数
- 总使用次数
- 最后使用时间
- 使用成功率
- 错误统计

### 🎯 **优化方向**
- 智能负载均衡
- 动态限制调整
- 使用预测
- 成本分析

这个机制确保了共享 API Key 的可持续性和公平性，让社区资源得到合理利用。
