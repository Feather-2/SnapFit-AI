# ä¿¡ä»»ç­‰çº§ä½¿ç”¨é™é¢ç³»ç»Ÿ

## ğŸ¯ **ç³»ç»Ÿæ¦‚è¿°**

åŸºäºç”¨æˆ·ä¿¡ä»»ç­‰çº§çš„æ¯æ—¥å¯¹è¯æ¬¡æ•°é™é¢ç³»ç»Ÿï¼Œç¡®ä¿èµ„æºåˆç†åˆ†é…å’Œç”¨æˆ·ä½“éªŒã€‚

### **é™é¢é…ç½®**
```
LV0: 0æ¬¡/å¤©    (æ–°ç”¨æˆ·ï¼Œæ— æ³•ä½¿ç”¨)
LV1: 40æ¬¡/å¤©   (ä¿¡ä»»ç”¨æˆ·)
LV2: 80æ¬¡/å¤©   (é«˜çº§ç”¨æˆ·)
LV3: 150æ¬¡/å¤©  (VIPç”¨æˆ·)
LV4: 150æ¬¡/å¤©  (è¶…çº§VIP)
```

## ğŸ”§ **æŠ€æœ¯æ¶æ„**

### **1. é…ç½®ç®¡ç†**

#### **é…ç½®æ–‡ä»¶** (`config/trust-level-limits.ts`)
```typescript
export const TRUST_LEVEL_CONFIGS: Record<number, TrustLevelConfig> = {
  1: {
    level: 1,
    name: "ä¿¡ä»»ç”¨æˆ·",
    limits: {
      dailyConversations: 40,  // ğŸ”¥ å¯é…ç½®
      dailyApiCalls: 100,
      monthlyUploads: 10
    },
    permissions: {
      canUseSharedService: true,
      canShareKeys: true
    }
  }
  // ... å…¶ä»–ç­‰çº§
}
```

#### **é…ç½®ç‰¹æ€§**
- âœ… **ä¸å†™æ­»**: æ‰€æœ‰é™é¢éƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­
- âœ… **æ˜“ä¿®æ”¹**: ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯è°ƒæ•´é™é¢
- âœ… **ç±»å‹å®‰å…¨**: TypeScriptç±»å‹å®šä¹‰
- âœ… **æ‰©å±•æ€§**: æ”¯æŒæ·»åŠ æ–°çš„é™é¢ç±»å‹

### **2. æ•°æ®å­˜å‚¨**

#### **daily_logsè¡¨ç»“æ„**
```sql
CREATE TABLE daily_logs (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  date DATE NOT NULL,
  log_data JSONB NOT NULL,  -- å­˜å‚¨ä½¿ç”¨æ•°æ®
  last_modified TIMESTAMP,
  UNIQUE(user_id, date)     -- æ¯ç”¨æˆ·æ¯å¤©ä¸€æ¡è®°å½•
);
```

#### **log_dataç»“æ„**
```json
{
  "conversation_count": 15,
  "api_call_count": 45,
  "upload_count": 3,
  "last_conversation_at": "2024-01-15T10:30:00Z"
}
```

### **3. ä½¿ç”¨é‡ç®¡ç†**

#### **UsageManagerç±»**
```typescript
class UsageManager {
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨
  async checkConversationLimit(userId: string, trustLevel: number)
  
  // è®°å½•ä½¿ç”¨
  async recordConversationUsage(userId: string)
  
  // è·å–ç»Ÿè®¡
  async getUserUsageStats(userId: string, days: number)
}
```

#### **æ ¸å¿ƒæ–¹æ³•**
- `checkConversationLimit()` - æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™æ¬¡æ•°
- `recordConversationUsage()` - è®°å½•ä¸€æ¬¡ä½¿ç”¨
- `getUserUsageStats()` - è·å–ä½¿ç”¨ç»Ÿè®¡

## ğŸ”„ **ä½¿ç”¨æµç¨‹**

### **å¯¹è¯å‰æ£€æŸ¥**
```typescript
// 1. æ£€æŸ¥é™é¢
const check = await usageManager.checkConversationLimit(userId, trustLevel)

if (!check.allowed) {
  return { error: 'å·²è¾¾åˆ°æ¯æ—¥é™é¢' }
}

// 2. è®°å½•ä½¿ç”¨
await usageManager.recordConversationUsage(userId)

// 3. å¼€å§‹å¯¹è¯
return { success: true }
```

### **APIç«¯ç‚¹**
```
GET  /api/usage/check?type=conversation  - æ£€æŸ¥é™é¢
POST /api/usage/check                    - è®°å½•ä½¿ç”¨
GET  /api/usage/stats?days=7             - è·å–ç»Ÿè®¡
```

## ğŸ¨ **ç”¨æˆ·ç•Œé¢**

### **1. å¯¼èˆªæ æ˜¾ç¤º**
```
[å¤´åƒğŸ‘‘] ç”¨æˆ·å
         [ğŸ‘‘ LV3] [âœ“ å¯ä½¿ç”¨å…±äº«æœåŠ¡]
         ä»Šæ—¥å¯¹è¯é¢åº¦: [15/150] â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 10%
```

#### **ç»„ä»¶**
- `UsageBadge` - æ˜¾ç¤ºå½“å‰ä½¿ç”¨é‡
- `UsageProgress` - æ˜¾ç¤ºä½¿ç”¨è¿›åº¦æ¡
- `UsageIndicator` - å®Œæ•´çš„ä½¿ç”¨é‡å¡ç‰‡

### **2. ä½¿ç”¨é‡æŒ‡ç¤ºå™¨**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ æ¯æ—¥å¯¹è¯é¢åº¦              [LV3] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… é¢åº¦å……è¶³                         â”‚
â”‚ 15 / 150                           â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%            â”‚
â”‚ å·²ä½¿ç”¨ 10% â€¢ 14å°æ—¶30åˆ†é’Ÿåé‡ç½®     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… æ‚¨è¿˜å¯ä»¥è¿›è¡Œ 135 æ¬¡å¯¹è¯          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ˆ 7æ—¥ç»Ÿè®¡                         â”‚
â”‚ æ€»å¯¹è¯: 89æ¬¡  æ—¥å‡å¯¹è¯: 12æ¬¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. React Hook**
```typescript
const {
  usageInfo,        // å½“å‰ä½¿ç”¨æƒ…å†µ
  canUse,          // æ˜¯å¦å¯ä»¥ä½¿ç”¨
  remaining,       // å‰©ä½™æ¬¡æ•°
  usagePercentage, // ä½¿ç”¨ç™¾åˆ†æ¯”
  startConversation // å¼€å§‹å¯¹è¯ï¼ˆæ£€æŸ¥+è®°å½•ï¼‰
} = useUsageLimit()
```

## ğŸ“Š **ä¸åŒç­‰çº§çš„ä½“éªŒ**

### **LV0 æ–°ç”¨æˆ·**
```
âŒ æ— æ³•ä½¿ç”¨å¯¹è¯åŠŸèƒ½
ğŸ’¡ æç¤ºï¼šæå‡åˆ°LV1è·å¾—40æ¬¡/å¤©é¢åº¦
```

### **LV1 ä¿¡ä»»ç”¨æˆ·**
```
âœ… 40æ¬¡/å¤©å¯¹è¯é¢åº¦
ğŸ“Š å¯¼èˆªæ æ˜¾ç¤ºä½¿ç”¨è¿›åº¦
âš ï¸ æ¥è¿‘é™é¢æ—¶æé†’
```

### **LV2 é«˜çº§ç”¨æˆ·**
```
âœ… 80æ¬¡/å¤©å¯¹è¯é¢åº¦ (ç¿»å€)
ğŸ“ˆ æ›´å®½æ¾çš„ä½¿ç”¨ä½“éªŒ
```

### **LV3-4 VIPç”¨æˆ·**
```
âœ… 150æ¬¡/å¤©å¯¹è¯é¢åº¦ (æœ€é«˜)
ğŸ‘‘ VIPèº«ä»½æ ‡è¯†
ğŸ¯ å……è¶³çš„ä½¿ç”¨é¢åº¦
```

## ğŸ” **ç›‘æ§å’Œç»Ÿè®¡**

### **ç”¨æˆ·ç»Ÿè®¡**
- ğŸ“Š **æ¯æ—¥ä½¿ç”¨é‡**: å½“å¤©å·²ä½¿ç”¨æ¬¡æ•°
- ğŸ“ˆ **å†å²è¶‹åŠ¿**: 7å¤©/30å¤©ä½¿ç”¨è¶‹åŠ¿
- ğŸ¯ **å¹³å‡ä½¿ç”¨**: æ—¥å‡ä½¿ç”¨é‡
- â° **é‡ç½®æ—¶é—´**: ä¸‹æ¬¡é‡ç½®å€’è®¡æ—¶

### **ç³»ç»Ÿç»Ÿè®¡**
- ğŸ‘¥ **ç”¨æˆ·åˆ†å¸ƒ**: å„ç­‰çº§ç”¨æˆ·æ•°é‡
- ğŸ“Š **ä½¿ç”¨åˆ†å¸ƒ**: å„ç­‰çº§ä½¿ç”¨é‡åˆ†å¸ƒ
- ğŸ”¥ **çƒ­é—¨æ—¶æ®µ**: ä½¿ç”¨é«˜å³°æ—¶æ®µ
- ğŸ“ˆ **å¢é•¿è¶‹åŠ¿**: ä½¿ç”¨é‡å¢é•¿è¶‹åŠ¿

## ğŸ›¡ï¸ **å®‰å…¨å’Œæ€§èƒ½**

### **é˜²åˆ·æœºåˆ¶**
- ğŸ”’ **ç”¨æˆ·è®¤è¯**: å¿…é¡»ç™»å½•æ‰èƒ½ä½¿ç”¨
- ğŸ¯ **ç²¾ç¡®è®¡æ•°**: æ¯æ¬¡ä½¿ç”¨éƒ½å‡†ç¡®è®°å½•
- â° **æ—¶é—´çª—å£**: æŒ‰è‡ªç„¶æ—¥é‡ç½®
- ğŸš« **è¶…é™æ‹’ç»**: è¶…è¿‡é™é¢ç«‹å³æ‹’ç»

### **æ€§èƒ½ä¼˜åŒ–**
- ğŸ“Š **JSONBå­˜å‚¨**: é«˜æ•ˆçš„JSONæ•°æ®å­˜å‚¨
- ğŸ” **ç´¢å¼•ä¼˜åŒ–**: ç”¨æˆ·ID+æ—¥æœŸå¤åˆç´¢å¼•
- ğŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†**: 90å¤©åè‡ªåŠ¨åˆ é™¤æ—§æ•°æ®
- âš¡ **ç¼“å­˜ç­–ç•¥**: çƒ­ç‚¹æ•°æ®ç¼“å­˜

## ğŸš€ **ä¸šåŠ¡ä»·å€¼**

### **èµ„æºç®¡ç†**
- ğŸ’° **æˆæœ¬æ§åˆ¶**: é˜²æ­¢èµ„æºæ»¥ç”¨
- âš–ï¸ **å…¬å¹³åˆ†é…**: æ ¹æ®è´¡çŒ®åˆ†é…èµ„æº
- ğŸ“ˆ **æ¿€åŠ±æœºåˆ¶**: é¼“åŠ±ç”¨æˆ·æå‡ç­‰çº§

### **ç”¨æˆ·ä½“éªŒ**
- ğŸ¯ **æ˜ç¡®é¢„æœŸ**: ç”¨æˆ·çŸ¥é“è‡ªå·±çš„é™é¢
- ğŸ“Š **é€æ˜å±•ç¤º**: å®æ—¶æ˜¾ç¤ºä½¿ç”¨æƒ…å†µ
- ğŸ† **ç­‰çº§æ¿€åŠ±**: æå‡ç­‰çº§è·å¾—æ›´å¤šé¢åº¦

### **ç¤¾åŒºå»ºè®¾**
- ğŸ¤ **ç­‰çº§ä½“ç³»**: æ¸…æ™°çš„ç”¨æˆ·ç­‰çº§åˆ’åˆ†
- ğŸ… **èº«ä»½è®¤åŒ**: é«˜ç­‰çº§ç”¨æˆ·è·å¾—ç‰¹æƒ
- ğŸŒŸ **æ´»è·ƒä¿ƒè¿›**: æ¿€åŠ±ç”¨æˆ·å‚ä¸ç¤¾åŒº

## ğŸ”„ **æ‰©å±•æ€§**

### **æ–°å¢é™é¢ç±»å‹**
```typescript
// é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ–°é™é¢
limits: {
  dailyConversations: 40,
  dailyImageGeneration: 10,  // ğŸ”¥ æ–°å¢
  monthlyFileStorage: 1000   // ğŸ”¥ æ–°å¢
}
```

### **æ–°å¢æƒé™**
```typescript
permissions: {
  canUseSharedService: true,
  canGenerateImages: true,   // ğŸ”¥ æ–°å¢
  canAccessPremiumModels: false // ğŸ”¥ æ–°å¢
}
```

### **åŠ¨æ€é…ç½®**
- ğŸ”§ **ç®¡ç†ç•Œé¢**: åå°åŠ¨æ€è°ƒæ•´é™é¢
- ğŸ“Š **A/Bæµ‹è¯•**: ä¸åŒç”¨æˆ·ç»„ä¸åŒé™é¢
- ğŸ¯ **ä¸ªæ€§åŒ–**: åŸºäºç”¨æˆ·è¡Œä¸ºè°ƒæ•´é™é¢

ç°åœ¨ç³»ç»Ÿå…·å¤‡äº†å®Œå–„çš„ä¿¡ä»»ç­‰çº§é™é¢ç®¡ç†ï¼Œç¡®ä¿èµ„æºåˆç†åˆ†é…çš„åŒæ—¶æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼ğŸ¯
