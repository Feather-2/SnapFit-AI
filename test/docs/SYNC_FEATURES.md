# 🔄 健康应用同步功能

## 📋 概述

健康应用现在支持完整的云同步功能，包括：

1. **健康日志数据** - 食物记录、运动记录、每日状态等
2. **AI记忆数据** - AI专家对用户的记忆内容
3. **用户档案数据** - 个人信息、健康目标、偏好设置

## 🚀 新增功能

### 1. AI记忆同步
- **自动同步**: AI记忆更新时自动推送到云端
- **手动同步**: 支持手动拉取/推送AI记忆
- **版本控制**: 基于版本号和时间戳的冲突解决

### 2. 用户档案同步
- **localStorage同步**: 将本地存储的用户档案同步到数据库
- **跨设备访问**: 在不同设备间保持用户设置一致
- **增量更新**: 只同步变更的数据

### 3. 完整同步
- **一键同步**: 同时同步所有类型的数据
- **登录自动同步**: 用户登录后自动执行完整同步
- **状态指示**: 实时显示同步状态和最后同步时间

## 🛠️ 技术实现

### 数据库表结构

#### ai_memories 表
```sql
CREATE TABLE ai_memories (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  expert_id VARCHAR(50),
  content TEXT,
  version INTEGER,
  last_updated TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, expert_id)
);
```

#### user_profiles 表 (扩展)
- 存储用户档案信息
- 支持健康目标、身体数据、偏好设置

### API 端点

#### AI记忆同步
- `GET /api/sync/memories` - 获取用户的AI记忆
- `POST /api/sync/memories` - 批量更新AI记忆

#### 用户档案同步
- `GET /api/sync/profile` - 获取用户档案
- `POST /api/sync/profile` - 更新用户档案

#### 健康日志同步 (已有)
- `GET /api/sync/logs` - 获取健康日志
- `POST /api/sync/logs` - 更新健康日志

### Hook 组件

#### useSync
- 统一的同步管理Hook
- 支持所有数据类型的同步
- 提供同步状态和错误处理

#### useAIMemorySync
- 专门的AI记忆同步Hook
- 支持单个记忆的实时同步
- 异步同步，不阻塞用户操作

## 📱 用户界面

### 设置页面同步控制
- **完整同步按钮**: 一键同步所有数据
- **分类同步按钮**: 分别同步不同类型的数据
- **同步状态显示**: 显示同步进度和最后同步时间
- **错误提示**: 同步失败时的详细错误信息

### 自动同步
- **登录时同步**: 用户登录后自动拉取云端数据
- **实时同步**: AI记忆更新时自动推送
- **后台同步**: 不影响用户正常使用

## 🔒 安全性

### 数据保护
- **用户隔离**: 每个用户只能访问自己的数据
- **权限验证**: 所有API都需要用户认证
- **数据加密**: 敏感数据在传输和存储时加密

### 冲突解决
- **时间戳优先**: 基于最后修改时间解决冲突
- **版本控制**: AI记忆使用版本号跟踪更新
- **数据完整性**: 确保同步过程中数据不丢失

## 🚀 使用方法

### 开发者
1. 运行数据库迁移: `add-ai-memories-table.sql`
2. 确保Supabase配置正确
3. 使用 `useSync` Hook 在组件中集成同步功能

### 用户
1. 登录应用后自动同步
2. 在设置页面手动触发同步
3. AI对话时记忆自动同步

## 📈 未来计划

- [ ] 离线同步队列
- [ ] 同步冲突的可视化解决
- [ ] 数据压缩和优化
- [ ] 同步性能监控
- [ ] 批量操作优化
