# ğŸ§ª æ•°æ®åŒæ­¥å®‰å…¨æ€§æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯æ–°çš„æ™ºèƒ½åŒæ­¥æœºåˆ¶èƒ½å¤Ÿï¼š
1. **é˜²æ­¢æ•°æ®ä¸¢å¤±** - å¤šç«¯åŒæ—¶ç¼–è¾‘æ—¶ä¸ä¼šè¦†ç›–æ•°æ®
2. **æ­£ç¡®åˆå¹¶æ•°ç»„** - åŸºäº `log_id` æ™ºèƒ½åˆå¹¶é£Ÿç‰©å’Œè¿åŠ¨æ¡ç›®
3. **å®‰å…¨åˆ é™¤æ¡ç›®** - åˆ é™¤æ“ä½œèƒ½æ­£ç¡®åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡
4. **å¤„ç†å†²çª** - æ—¶é—´æˆ³å†²çªæ—¶èƒ½æ™ºèƒ½è§£å†³

## ğŸ”§ æµ‹è¯•å‰å‡†å¤‡

### 1. éƒ¨ç½²æ•°æ®åº“å‡½æ•°
```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
-- ç¡®ä¿ä»¥ä¸‹å‡½æ•°å·²åˆ›å»ºï¼š
-- âœ… upsert_log_patch()
-- âœ… merge_arrays_by_log_id()  
-- âœ… remove_log_entry()
```

### 2. éªŒè¯APIç«¯ç‚¹
- âœ… `/api/sync/logs` (GET/POST)
- âœ… `/api/sync/logs/remove-entry` (POST)

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: å¤šç«¯åŒæ—¶æ·»åŠ æ•°æ®

**æ­¥éª¤**ï¼š
1. è®¾å¤‡A: æ·»åŠ ä¸€æ¡é£Ÿç‰©è®°å½• (ç‰ç±³)
2. è®¾å¤‡B: åŒæ—¶æ·»åŠ ä¸€æ¡è¿åŠ¨è®°å½• (è·‘æ­¥)
3. ä¸¤è®¾å¤‡éƒ½åŒæ­¥åˆ°æœåŠ¡å™¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¸¤æ¡è®°å½•éƒ½ä¿ç•™
- âœ… æ²¡æœ‰æ•°æ®ä¸¢å¤±
- âœ… æœ€ååŒæ­¥çš„è®¾å¤‡åŒ…å«æ‰€æœ‰æ•°æ®

**æµ‹è¯•æ•°æ®**ï¼š
```json
// è®¾å¤‡Aæ·»åŠ 
{
  "foodEntries": [{
    "log_id": "food-001",
    "food_name": "ç‰ç±³æ£’å­",
    "consumed_grams": 200
  }]
}

// è®¾å¤‡Bæ·»åŠ   
{
  "exerciseEntries": [{
    "log_id": "exercise-001", 
    "exercise_name": "è·‘æ­¥",
    "duration_minutes": 30
  }]
}

// åˆå¹¶ååº”åŒ…å«ä¸¤æ¡è®°å½•
```

### åœºæ™¯2: åŒä¸€æ¡ç›®çš„å¹¶å‘ç¼–è¾‘

**æ­¥éª¤**ï¼š
1. è®¾å¤‡A: ä¿®æ”¹é£Ÿç‰©è®°å½•çš„é‡é‡ (200g â†’ 250g)
2. è®¾å¤‡B: ä¿®æ”¹åŒä¸€é£Ÿç‰©è®°å½•çš„å¤‡æ³¨
3. ä¸¤è®¾å¤‡åŒæ­¥

**é¢„æœŸç»“æœ**ï¼š
- âœ… ååŒæ­¥çš„è®¾å¤‡è·èƒœ
- âœ… æ•´ä¸ªæ¡ç›®è¢«æœ€æ–°ç‰ˆæœ¬æ›¿æ¢
- âœ… æ—¶é—´æˆ³æ­£ç¡®æ›´æ–°

### åœºæ™¯3: åˆ é™¤æ“ä½œåŒæ­¥

**æ­¥éª¤**ï¼š
1. è®¾å¤‡A: åˆ é™¤ä¸€æ¡é£Ÿç‰©è®°å½•
2. è®¾å¤‡B: æ·»åŠ ä¸€æ¡æ–°çš„è¿åŠ¨è®°å½•
3. ä¸¤è®¾å¤‡åŒæ­¥

**é¢„æœŸç»“æœ**ï¼š
- âœ… é£Ÿç‰©è®°å½•åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šè¢«åˆ é™¤
- âœ… æ–°è¿åŠ¨è®°å½•åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå‡ºç°
- âœ… æ•°ç»„é•¿åº¦æ­£ç¡®

### åœºæ™¯4: ç¦»çº¿ç¼–è¾‘å†²çª

**æ­¥éª¤**ï¼š
1. è®¾å¤‡A: ç¦»çº¿æ·»åŠ 3æ¡è®°å½•
2. è®¾å¤‡B: ç¦»çº¿æ·»åŠ 2æ¡è®°å½•  
3. è®¾å¤‡Aå…ˆåŒæ­¥
4. è®¾å¤‡BååŒæ­¥

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ€»å…±5æ¡è®°å½•éƒ½ä¿ç•™
- âœ… æ²¡æœ‰é‡å¤çš„ log_id
- âœ… æ—¶é—´æˆ³åæ˜ æœ€ååŒæ­¥æ—¶é—´

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ•°æ®åº“ç›´æ¥æŸ¥è¯¢
```sql
-- æŸ¥çœ‹ç‰¹å®šæ—¥æœŸçš„æ—¥å¿—æ•°æ®
SELECT 
  user_id,
  date,
  jsonb_array_length(log_data->'foodEntries') as food_count,
  jsonb_array_length(log_data->'exerciseEntries') as exercise_count,
  last_modified
FROM daily_logs 
WHERE date = '2025-06-09'
ORDER BY last_modified DESC;

-- æ£€æŸ¥æ•°ç»„å†…å®¹
SELECT 
  date,
  jsonb_pretty(log_data->'foodEntries') as food_entries,
  jsonb_pretty(log_data->'exerciseEntries') as exercise_entries
FROM daily_logs 
WHERE user_id = 'your-user-id' AND date = '2025-06-09';
```

### 2. å‰ç«¯æ§åˆ¶å°ç›‘æ§
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ç›‘æ§åŒæ­¥æ—¥å¿—
// æŸ¥æ‰¾ä»¥ä¸‹å…³é”®è¯ï¼š
// - "[Sync] Merging arrays"
// - "[Sync] Conflict detected" 
// - "[Sync] Successfully merged"
```

### 3. ç½‘ç»œè¯·æ±‚æ£€æŸ¥
- æ£€æŸ¥ `/api/sync/logs` çš„è¯·æ±‚ä½“
- éªŒè¯ `log_data_patch` å­—æ®µå†…å®¹
- ç¡®è®¤å“åº”çŠ¶æ€ç ä¸º 200

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æ•°æ®ä»ç„¶è¢«è¦†ç›–
**å¯èƒ½åŸå› **ï¼š
- `upsert_log_patch` å‡½æ•°æœªæ­£ç¡®éƒ¨ç½²
- å®¢æˆ·ç«¯ä»ä½¿ç”¨æ—§çš„åŒæ­¥é€»è¾‘

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT proname FROM pg_proc WHERE proname = 'upsert_log_patch';

-- é‡æ–°éƒ¨ç½²å‡½æ•°
\i database/migrations/add-daily-logs-table.sql
```

### é—®é¢˜2: log_id é‡å¤
**å¯èƒ½åŸå› **ï¼š
- å®¢æˆ·ç«¯ç”Ÿæˆ UUID é€»è¾‘æœ‰é—®é¢˜
- åˆå¹¶å‡½æ•°é€»è¾‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ£€æŸ¥ log_id ç”Ÿæˆ
console.log('Generated log_id:', crypto.randomUUID());

// éªŒè¯åˆå¹¶é€»è¾‘
const merged = mergeEntriesByLogId(localEntries, serverEntries);
console.log('Merged entries:', merged);
```

### é—®é¢˜3: åˆ é™¤æ“ä½œå¤±è´¥
**å¯èƒ½åŸå› **ï¼š
- `remove_log_entry` å‡½æ•°æœªéƒ¨ç½²
- API ç«¯ç‚¹è·¯å¾„é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ API ç«¯ç‚¹
curl -X POST http://localhost:3000/api/sync/logs/remove-entry \
  -H "Content-Type: application/json" \
  -d '{"date":"2025-06-09","entryType":"food","logId":"test-id"}'
```

## âœ… æˆåŠŸæ ‡å‡†

æµ‹è¯•é€šè¿‡çš„æ ‡å‡†ï¼š
- [ ] æ‰€æœ‰åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®åº“ä¸­æ— é‡å¤ log_id
- [ ] æ—¶é—´æˆ³é€»è¾‘æ­£ç¡®
- [ ] åˆ é™¤æ“ä½œåŒæ­¥æˆåŠŸ
- [ ] æ— æ•°æ®ä¸¢å¤±äº‹ä»¶
- [ ] å‰ç«¯ç”¨æˆ·ä½“éªŒè‰¯å¥½

## ğŸ“Š æ€§èƒ½ç›‘æ§

å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
- **åŒæ­¥å»¶è¿Ÿ**: < 2ç§’
- **å†²çªè§£å†³æ—¶é—´**: < 1ç§’  
- **æ•°æ®åº“æŸ¥è¯¢æ—¶é—´**: < 500ms
- **å†…å­˜ä½¿ç”¨**: åˆå¹¶æ“ä½œä¸åº”å¯¼è‡´å†…å­˜æ³„æ¼

## ğŸ”® åç»­æ”¹è¿›

åŸºäºæµ‹è¯•ç»“æœçš„æ”¹è¿›æ–¹å‘ï¼š
1. **å¯è§†åŒ–å†²çªè§£å†³** - æ˜¾ç¤ºåˆå¹¶è¯¦æƒ…
2. **å®æ—¶åŒæ­¥** - WebSocket æ¨é€æ›´æ–°
3. **ç‰ˆæœ¬å†å²** - ä¿ç•™æ•°æ®å˜æ›´å†å²
4. **æ€§èƒ½ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„åŒæ­¥è¯·æ±‚
