# 问题修复部署指南

本文档描述了针对您提到的4个问题的修复方案，以及如何部署这些修复。

## 修复内容总览

### 1. ✅ 个人信息保存到服务端
**问题**: 个人信息没有保存到服务端
**修复**: 
- 将设置页面的用户配置保存从本地存储改为服务端存储
- 使用 `useUserProfileServer` hook 替代 `useLocalStorage`
- 添加错误处理和用户反馈

### 2. ✅ 设置页面选项卡样式优化
**问题**: 设置页面中的选项卡存在样式问题
**修复**:
- 优化选项卡的响应式布局
- 添加 `min-w-0 flex-1` 类确保均匀分布
- 改进移动端显示效果

### 3. ✅ 首页卡路里计算修复
**问题**: 首页的今日汇总中卡路里摄入、运动消耗、净卡路里都是0
**修复**:
- 修复 `lib/summary-utils.ts` 中的字段名称不匹配问题
- 支持数据库驼峰命名和类型定义下划线命名两种方式
- 添加JSON字符串解析逻辑

### 4. ✅ 缓存问题解决方案
**问题**: 每次更新重新部署后，已访问过的设备无法应用最新网站
**修复**:
- 在 Next.js 配置中添加缓存控制头
- 实现版本检查和强制刷新机制
- 添加构建时间和版本号环境变量

## 部署步骤

### 步骤1: 验证修复
```bash
# 运行测试脚本验证所有修复
node scripts/test-fixes.js
```

### 步骤2: 更新环境变量
在您的 `.env` 文件中添加（可选）:
```env
NEXT_PUBLIC_APP_VERSION=1.0.1
NEXT_PUBLIC_BUILD_TIME=2024-01-01T00:00:00Z
```

### 步骤3: 重新构建应用

#### 本地开发环境
```bash
# 安装依赖
pnpm install

# 重新构建
pnpm build

# 启动应用
pnpm start
```

#### Docker 部署
```bash
# 重新构建 Docker 镜像
docker build -t snapifit-ai .

# 停止现有容器
docker-compose down

# 启动新容器
docker-compose up -d
```

### 步骤4: 验证修复效果

1. **个人信息保存测试**:
   - 访问设置页面
   - 修改个人信息并保存
   - 刷新页面确认数据已保存到服务端

2. **选项卡样式测试**:
   - 在不同设备尺寸下查看设置页面
   - 确认选项卡在移动端正常显示

3. **卡路里计算测试**:
   - 添加食物和运动记录
   - 查看首页今日汇总是否正确显示卡路里数据

4. **缓存问题测试**:
   - 部署新版本后访问应用
   - 应该看到版本更新提示对话框
   - 点击刷新后应用最新版本

## 额外建议

### 反向代理配置
如果您使用 nginx 反向代理，建议更新配置以支持缓存控制：

```nginx
# 在 nginx.conf 中添加
location / {
    proxy_pass http://your-app:3000;
    proxy_set_header Cache-Control "no-cache, no-store, must-revalidate";
    proxy_set_header Pragma "no-cache";
    proxy_set_header Expires "0";
}

# 静态资源可以缓存
location /_next/static/ {
    proxy_pass http://your-app:3000;
    proxy_cache_valid 60m;
    add_header Cache-Control "public, max-age=3600";
}
```

### 监控和日志
建议添加日志来监控修复效果：
- 监控用户配置保存成功率
- 记录版本更新提示的显示频率
- 跟踪卡路里计算的准确性

## 故障排除

### 如果个人信息仍未保存
1. 检查数据库连接
2. 查看服务端日志中的错误信息
3. 确认用户已登录且有有效的认证令牌

### 如果卡路里仍显示为0
1. 检查数据库中的食物和运动记录格式
2. 查看浏览器控制台是否有JavaScript错误
3. 验证营养信息的JSON格式是否正确

### 如果缓存问题仍存在
1. 清除浏览器缓存和本地存储
2. 检查CDN或反向代理的缓存设置
3. 确认版本检查器组件正常加载

## 联系支持
如果在部署过程中遇到问题，请提供：
- 错误日志
- 浏览器控制台输出
- 部署环境详细信息
