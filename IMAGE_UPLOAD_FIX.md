# é¥®é£Ÿè®°å½•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**é¥®é£Ÿè®°å½•è¿™ç§ï¼Œç›´æ¥å‘æ–‡å­—å¯ä»¥ï¼Œå‘å›¾ç‰‡æ€ä¹ˆä¸è¡Œå‘¢**

## ğŸ” é—®é¢˜åˆ†æ

é€šè¿‡ä»£ç å®¡æŸ¥å‘ç°ï¼Œå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### **1. APIç«¯ç‚¹ç¼ºå°‘èº«ä»½éªŒè¯**
- `/api/openai/parse-with-images` ç«¯ç‚¹ç¼ºå°‘ç”¨æˆ·èº«ä»½éªŒè¯
- æ²¡æœ‰å®ç°ä½¿ç”¨é™é¢æ£€æŸ¥
- ç¼ºå°‘é”™è¯¯å›æ»šæœºåˆ¶

### **2. åŠŸèƒ½å¯¹æ¯”**
| åŠŸèƒ½ | `/api/openai/parse-image` | `/api/openai/parse-with-images` |
|------|---------------------------|--------------------------------|
| èº«ä»½éªŒè¯ | âœ… å®Œæ•´å®ç° | âŒ ç¼ºå¤± |
| ä½¿ç”¨é™é¢æ£€æŸ¥ | âœ… å®Œæ•´å®ç° | âŒ ç¼ºå¤± |
| é”™è¯¯å›æ»š | âœ… å®Œæ•´å®ç° | âŒ ç¼ºå¤± |
| å›¾ç‰‡å¤„ç† | âœ… å•å¼ å›¾ç‰‡ | âœ… å¤šå¼ å›¾ç‰‡ |

### **3. å‰ç«¯é€»è¾‘**
```typescript
// å‰ç«¯æ ¹æ®æ˜¯å¦æœ‰å›¾ç‰‡é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
const endpoint = uploadedImages.length > 0 
  ? "/api/openai/parse-with-images"  // æœ‰å›¾ç‰‡æ—¶ä½¿ç”¨
  : "/api/openai/parse-shared";      // çº¯æ–‡å­—æ—¶ä½¿ç”¨
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### **1. æ·»åŠ èº«ä»½éªŒè¯å±‚**
```typescript
// ğŸ”’ ç¬¬1å±‚ï¼šç”¨æˆ·èº«ä»½éªŒè¯
const session = await auth()
if (!session?.user?.id) {
  return Response.json({
    error: 'Authentication required',
    code: 'UNAUTHORIZED'
  }, { status: 401 })
}

// ğŸ”’ ç¬¬2å±‚ï¼šè·å–ç”¨æˆ·ä¿¡ä»»ç­‰çº§
const userManager = new UserManager()
const userResult = await userManager.getUserById(session.user.id)

// ğŸ”’ ç¬¬3å±‚ï¼šåŸå­æ€§é™é¢æ£€æŸ¥å’Œè®°å½•
const usageManager = new UsageManager()
const usageResult = await usageManager.checkAndRecordUsage(
  session.user.id,
  userResult.user.trustLevel,
  'conversation_count'
)
```

### **2. æ·»åŠ ä½¿ç”¨é™é¢ä¿æŠ¤**
```typescript
// ğŸš« ç»å¯¹ä¸å…è®¸è¶…è¿‡é™é¢
if (!usageResult.allowed) {
  return Response.json({
    error: 'Daily usage limit exceeded',
    code: 'LIMIT_EXCEEDED',
    details: {
      currentUsage: usageResult.newCount,
      dailyLimit: usageResult.limit,
      trustLevel: userResult.user.trustLevel
    }
  }, { status: 429 })
}
```

### **3. æ·»åŠ é”™è¯¯å›æ»šæœºåˆ¶**
```typescript
// ğŸ”„ è¾“å…¥æ— æ•ˆæ—¶å›æ»šä½¿ç”¨è®¡æ•°
if (images.length === 0) {
  await usageManager.rollbackUsage(session.user.id, 'conversation_count')
  return Response.json({ error: "No images provided" }, { status: 400 })
}

// ğŸ”„ AIæœåŠ¡å¤±è´¥æ—¶å›æ»šä½¿ç”¨è®¡æ•°
catch (error) {
  const session = await auth()
  if (session?.user?.id) {
    const usageManager = new UsageManager()
    await usageManager.rollbackUsage(session.user.id, 'conversation_count')
  }
  // ... é”™è¯¯å¤„ç†
}
```

## âœ… ä¿®å¤ç»“æœ

### **ä¿®å¤å‰çš„é—®é¢˜**
- âŒ å›¾ç‰‡ä¸Šä¼ æ—¶æ²¡æœ‰èº«ä»½éªŒè¯ï¼Œå¯¼è‡´è¯·æ±‚è¢«æ‹’ç»
- âŒ æ²¡æœ‰ä½¿ç”¨é™é¢æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´æ»¥ç”¨
- âŒ é”™è¯¯å¤„ç†ä¸å®Œæ•´ï¼Œç”¨æˆ·ä½“éªŒå·®

### **ä¿®å¤åçš„æ”¹è¿›**
- âœ… **å®Œæ•´çš„èº«ä»½éªŒè¯**: ç¡®ä¿åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥ä½¿ç”¨
- âœ… **ä½¿ç”¨é™é¢ä¿æŠ¤**: é˜²æ­¢APIæ»¥ç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿèµ„æº
- âœ… **æ™ºèƒ½é”™è¯¯å›æ»š**: å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šä½¿ç”¨è®¡æ•°
- âœ… **ä¸€è‡´çš„å®‰å…¨ç­–ç•¥**: ä¸å…¶ä»–APIç«¯ç‚¹ä¿æŒä¸€è‡´

### **åŠŸèƒ½éªŒè¯**
1. **æ–‡å­—è¾“å…¥**: ä½¿ç”¨ `/api/openai/parse-shared` âœ…
2. **å›¾ç‰‡ä¸Šä¼ **: ä½¿ç”¨ `/api/openai/parse-with-images` âœ…
3. **èº«ä»½éªŒè¯**: æ‰€æœ‰ç«¯ç‚¹éƒ½æœ‰å®Œæ•´éªŒè¯ âœ…
4. **ä½¿ç”¨é™é¢**: æ‰€æœ‰ç«¯ç‚¹éƒ½æœ‰é™é¢ä¿æŠ¤ âœ…

## ğŸ¯ ç”¨æˆ·ä½“éªŒæå‡

### **ä¿®å¤å‰**
- ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åæ”¶åˆ°æ¨¡ç³Šçš„é”™è¯¯ä¿¡æ¯
- æ— æ³•æ­£å¸¸ä½¿ç”¨å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
- ä½“éªŒä¸ä¸€è‡´ï¼ˆæ–‡å­—å¯ä»¥ï¼Œå›¾ç‰‡ä¸è¡Œï¼‰

### **ä¿®å¤å**
- å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- æ¸…æ™°çš„é”™è¯¯æç¤ºå’Œé™é¢ä¿¡æ¯
- ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒï¼ˆæ–‡å­—å’Œå›¾ç‰‡éƒ½å¯ä»¥ï¼‰

## ğŸ”’ å®‰å…¨æ€§æ”¹è¿›

### **èº«ä»½éªŒè¯æµç¨‹**
1. **SessionéªŒè¯**: ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
2. **ç”¨æˆ·æŸ¥è¯¢**: è·å–ç”¨æˆ·ä¿¡ä»»ç­‰çº§
3. **é™é¢æ£€æŸ¥**: æ ¹æ®ä¿¡ä»»ç­‰çº§æ£€æŸ¥ä½¿ç”¨é™é¢
4. **åŸå­æ“ä½œ**: æ£€æŸ¥å’Œè®°å½•ä½¿ç”¨é‡çš„åŸå­æ€§æ“ä½œ

### **é”™è¯¯å¤„ç†**
- **è¾“å…¥éªŒè¯å¤±è´¥**: è‡ªåŠ¨å›æ»šä½¿ç”¨è®¡æ•°
- **AIæœåŠ¡å¤±è´¥**: è‡ªåŠ¨å›æ»šä½¿ç”¨è®¡æ•°
- **é…ç½®é”™è¯¯**: è‡ªåŠ¨å›æ»šä½¿ç”¨è®¡æ•°

### **é™é¢ä¿æŠ¤**
- **ä¿¡ä»»ç­‰çº§é™åˆ¶**: LV1=40, LV2=80, LV3/4=150
- **æ¯æ—¥é‡ç½®**: ä½¿ç”¨è®¡æ•°æ¯æ—¥è‡ªåŠ¨é‡ç½®
- **å®æ—¶æ£€æŸ¥**: æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œå®æ—¶é™é¢æ£€æŸ¥

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### **ä¿®æ”¹çš„æ–‡ä»¶**
- `app/api/openai/parse-with-images/route.ts`: ä¸»è¦ä¿®å¤æ–‡ä»¶

### **æ·»åŠ çš„ä¾èµ–**
```typescript
import { auth } from '@/lib/auth'
import { UsageManager } from '@/lib/usage-manager'
import { UserManager } from '@/lib/user-manager'
```

### **ä»£ç å˜æ›´ç»Ÿè®¡**
- **æ–°å¢ä»£ç **: ~60è¡Œï¼ˆèº«ä»½éªŒè¯å’Œé”™è¯¯å¤„ç†ï¼‰
- **ä¿®æ”¹ä»£ç **: ~10è¡Œï¼ˆé”™è¯¯å¤„ç†é€»è¾‘ï¼‰
- **åˆ é™¤ä»£ç **: 1è¡Œï¼ˆæœªä½¿ç”¨çš„å¯¼å…¥ï¼‰

## ğŸš€ æµ‹è¯•å»ºè®®

### **åŠŸèƒ½æµ‹è¯•**
1. **ç™»å½•çŠ¶æ€æµ‹è¯•**: æœªç™»å½•æ—¶åº”è¿”å›401é”™è¯¯
2. **å›¾ç‰‡ä¸Šä¼ æµ‹è¯•**: ä¸Šä¼ 1-5å¼ å›¾ç‰‡åº”æ­£å¸¸å·¥ä½œ
3. **é™é¢æµ‹è¯•**: è¶…è¿‡æ¯æ—¥é™é¢åº”è¿”å›429é”™è¯¯
4. **é”™è¯¯æ¢å¤æµ‹è¯•**: å„ç§é”™è¯¯æƒ…å†µä¸‹çš„å›æ»šæœºåˆ¶

### **æ€§èƒ½æµ‹è¯•**
1. **å¤§å›¾ç‰‡å¤„ç†**: æµ‹è¯•500KBå‹ç¼©åçš„å›¾ç‰‡å¤„ç†
2. **å¤šå›¾ç‰‡å¤„ç†**: æµ‹è¯•åŒæ—¶ä¸Šä¼ å¤šå¼ å›¾ç‰‡çš„æ€§èƒ½
3. **å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¤šç”¨æˆ·åŒæ—¶ä½¿ç”¨çš„æƒ…å†µ

ç°åœ¨é¥®é£Ÿè®°å½•çš„å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å·²ç»å®Œå…¨ä¿®å¤ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨æ–‡å­—å’Œå›¾ç‰‡ä¸¤ç§æ–¹å¼è®°å½•é¥®é£Ÿä¿¡æ¯ï¼
